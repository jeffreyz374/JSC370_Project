---
title: "JSC370 Final Project"
author: "Xiaotang (Jeffrey) Zhou"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---

<br>

This is my JSC370 Final Project website. I will showcase a few interactive visuals here.

<br>

```{r setup, message=FALSE, echo=FALSE, warning=FALSE}

library(data.table)
library(tidyverse)
library(dplyr)
library(plotly)
library(DT)
library(knitr)
library(RCurl)

# Initialize code chunk options
opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  eval=TRUE,
  echo = TRUE,
  cache = FALSE,
  fig.width = 7, 
  fig.align = 'center',
  fig.asp = 0.618,
  out.width = "700px",
  class.source = "code-r")

ovi_data <- getURL("https://raw.githubusercontent.com/jeffreyz374/JSC370_Project/main/ovi-data.csv")
ovi_data <- read.csv(text = ovi_data)
  

gretzky_data <- getURL("https://raw.githubusercontent.com/jeffreyz374/JSC370_Project/main/gretzky-data.csv")
gretzky_data <- read.csv(text = gretzky_data)

ovi_goals_by_date <- ovi_data %>%
  group_by(Date) %>%
  summarise(Goals = n())

unique_date_opponent_pairs <- ovi_data %>%
  select(c("Date", "Opponent")) %>%
  distinct(Date, Opponent)

ovi_goals_by_date <- merge(ovi_goals_by_date, unique_date_opponent_pairs)

caps_wins_by_date <- ovi_data %>%
  distinct(Date, Result)

x_ovi <- merge(ovi_goals_by_date, caps_wins_by_date)

gretzky_goals_by_date <- gretzky_data %>%
  group_by(Date) %>%
  summarise(Goals = n())

wins_by_date <- gretzky_data %>%
  distinct(Date, Result)

x_gretzky <- merge(gretzky_goals_by_date, wins_by_date)

ovi_potential_games <- getURL("https://raw.githubusercontent.com/jeffreyz374/JSC370_Project/main/ovi-potential-games.csv")
ovi_potential_games <- read.csv(text = ovi_potential_games)

gretzky_potential_games <- getURL("https://raw.githubusercontent.com/jeffreyz374/JSC370_Project/main/gretzky-potential-games.csv")
gretzky_potential_games <- read.csv(text = gretzky_potential_games)

name_table <- getURL("https://raw.githubusercontent.com/jeffreyz374/JSC370_Project/main/name-table.csv")
name_table <- read.csv(text = name_table)

```

```{css, echo = FALSE}
.code-r { /* Code block */
  font-size: 15px;
}

.code-r-small { /* Code block */
  font-size: 10px;
}
```

<br>

## Ovechkin and Gretzky Goals By Age {.tabset}

This interactive visual shows the number of goals scored by Ovechkin and Gretzky grouped by the age at which each player scored those goals (as Ovechkin is still active in the NHL, his data is accurate as of April 12 2022):

```{r, echo = FALSE}
gretzky_age_stats <- gretzky_data %>%
  group_by(Age) %>%
  summarise(Goals = n())

ovi_age_stats <- ovi_data %>%
  group_by(Age) %>%
  summarise(Goals = n())

ovi_age_goals <- ovi_age_stats %>%
  ggplot(aes(x = Age, Goals)) +
  geom_bar(stat = "identity", fill = "red") +
  ylab("Goals") +
  ggtitle("Number of goals scored by Ovechkin at varying ages in his NHL career") +
  theme_minimal()

gretzky_age_goals <- gretzky_age_stats %>%
  ggplot(aes(x = Age, Goals)) +
  geom_bar(stat = "identity", fill = "blue") +
  ylab("Goals") +
  ggtitle("Number of goals scored by Gretzky at varying ages in his NHL career") +
  theme_minimal()

joint <- left_join(gretzky_age_stats, ovi_age_stats, by = "Age") %>%
  rename(Gretzky = Goals.x, Ovechkin = Goals.y)
joint[is.na(joint)] <- 0

ovi_gretzky_joint <- joint %>%
  gather(Player, Goals, -Age) %>%
  ggplot(aes(x = Age, y = Goals, fill = Player)) +
  scale_fill_manual(values = c("blue", "red")) +
  geom_col(position = "dodge") +
  ylab("Goals") +
  ggtitle("Comparison of the number of goals scored by both \n Ovechkin and Gretzky at varying ages in their NHL careers") +
  theme_minimal()
```

### Ovechkin

```{r, echo = FALSE}
ggplotly(ovi_age_goals) %>%
  layout(hoverlabel=list(bgcolor="white"))
```

### Gretzky

```{r, echo = FALSE}
ggplotly(gretzky_age_goals) %>%
  layout(hoverlabel=list(bgcolor="white"))
```

### Both

```{r, echo = FALSE}
ggplotly(ovi_gretzky_joint)%>%
  layout(hoverlabel=list(bgcolor="white"))
```


## {-}

<br>

## Information About Every Ovechkin and Gretzky Goal {.tabset}

This interactive visual displays information about all of the goals that Ovechkin and Gretzky have scored (as Ovechkin is still active in the NHL, his table is accurate as of April 12 2022):

```{r, echo = FALSE}
# datatable2 - datatable with child rows
datatable2 <- function(x, vars = NULL, opts = NULL, ...) {
  
  names_x <- names(x)
  if (is.null(vars)) stop("'vars' must be specified!")
  pos <- match(vars, names_x)
  if (any(map_chr(x[, pos], typeof) == "list"))
    stop("list columns are not supported in datatable2()")
  
  pos <- pos[pos <= ncol(x)] + 1
  rownames(x) <- NULL
  if (nrow(x) > 0) x <- cbind(' ' = '&oplus;', x)

  # options
  opts <- c(
    opts, 
    list(
      columnDefs = list(
        list(visible = FALSE, targets = c(0, pos)),
        list(orderable = FALSE, className = 'details-control', targets = 1),
        list(className = 'dt-left', targets = 1:3),
        list(className = 'dt-right', targets = 4:ncol(x))
      )
  ))
  
  datatable(
    x, 
    ...,
    escape = -2,
    options = opts,
    callback = JS(.callback2(x = x, pos = c(0, pos)))
  )
}

.callback2 <- function(x, pos = NULL) {
  
  part1 <- "table.column(1).nodes().to$().css({cursor: 'pointer'});"
  
  part2 <- .child_row_table2(x, pos = pos)
  
  part3 <- 
  "
   table.on('click', 'td.details-control', function() {
    var td = $(this), row = table.row(td.closest('tr'));
    if (row.child.isShown()) {
      row.child.hide();
      td.html('&oplus;');
    } else {
      row.child(format(row.data())).show();
      td.html('&ominus;');
    }
  });"
  
  paste(part1, part2, part3)
} 

.child_row_table2 <- function(x, pos = NULL) {
  
  names_x <- paste0(names(x), ":")
  text <- "
  var format = function(d) {
    text = '<div><table >' + 
  "

  for (i in seq_along(pos)) {
    text <- paste(text, glue::glue(
        "'<tr>' +
          '<td>' + '{names_x[pos[i]]}' + '</td>' +
          '<td>' + d[{pos[i]}] + '</td>' +
        '</tr>' + " ))
  }

  paste0(text,
    "'</table></div>'
      return text;};"
  )
}
```

```{r, echo = FALSE}
ovi_data_copy <- ovi_data
ovi_data_copy[is.na(ovi_data_copy)] <- "N/A"
ovi_data_copy$PS <- case_when(ovi_data_copy$PS == 0 ~ "No", ovi_data_copy$PS == 1 ~ "Yes")
ovi_data_copy$ENG <- case_when(ovi_data_copy$ENG == 0 ~ "No", ovi_data_copy$ENG == 1 ~ "Yes")
ovi_data_copy$Result <- case_when(ovi_data_copy$Result == "W" ~ "Regulation Win",
                                  ovi_data_copy$Result == "L" ~ "Regulation Loss",
                                  ovi_data_copy$Result == "OTW" ~ "Overtime Win",
                                  ovi_data_copy$Result == "OTL" ~ "Overtime Loss",
                                  ovi_data_copy$Result == "SOW" ~ "Shootout Win",
                                  ovi_data_copy$Result == "SOL" ~ "Shootout Loss")
ovi_data_copy$HomeAway <- case_when(ovi_data_copy$HomeAway == "H" ~ "Home", ovi_data_copy$HomeAway == "A" ~ "Away")
ovi_data_copy$Strength <- case_when(ovi_data_copy$Strength == "EV" ~ "Even Strength", ovi_data_copy$Strength == "PP" ~ "Power Play", ovi_data_copy$Strength == "SH" ~ "Shorthanded")
ovi_data_copy$Time <- substr(ovi_data_copy$Time, start = 1, stop = 5)
ovi_data_copy$Team <- rep("Washington Capitals", nrow(ovi_data_copy))

ovi_data_copy <- merge(ovi_data_copy, name_table, by.x = c("Opponent"), by.y = c("Abbreviation"))

ovi_data_copy <- ovi_data_copy[c(2:ncol(ovi_data_copy))]

colnames(ovi_data_copy) <- c("Date", "Team", "Age", "1st Assist", "2nd Assist", "Goalie", "Period", "Time", "Strength", "Arena", "Home/Away", "Result", "Empty Net Goal", "Penalty Shot Goal", "Opponent")

ovi_data_copy <- ovi_data_copy[, c(1, 2, 15, 3:14)]

ovi_data_copy <- left_join(ovi_data_copy, ovi_potential_games[c(1, 3, 4)], by = "Date") %>%
  mutate(Final = paste(GF, "-", GA))

ovi_data_copy <- ovi_data_copy[, c(1:13, 18, 14:15)]

colnames(ovi_data_copy) <- c("Date", "Team", "Opponent", "Age", "1st Assist", "2nd Assist", "Goalie", "Period", "Time", "Strength", "Arena", "Home/Away", "Result", "Final Score", "Empty Net Goal", "Penalty Shot Goal")

ovi_data_copy <- ovi_data_copy %>%
  arrange(desc(Date))

ovi_data_copy$cgoal <- rev(c(1:776))

ovi_data_copy <- ovi_data_copy[, c(1:4, 17, 5:16)]

colnames(ovi_data_copy) <- c("Date", "Team", "Opponent", "Age", "Career Goal Number", "1st Assist", "2nd Assist", "Goalie", "Period", "Time", "Strength", "Arena", "Home/Away", "Result", "Final Score", "Empty Net Goal", "Penalty Shot Goal")
```

```{r, echo = FALSE}
gretzky_data_copy <- gretzky_data
gretzky_data_copy[is.na(gretzky_data_copy)] <- "N/A"
gretzky_data_copy$PS <- case_when(gretzky_data_copy$PS == 0 ~ "No", gretzky_data_copy$PS == 1 ~ "Yes")
gretzky_data_copy$ENG <- case_when(gretzky_data_copy$ENG == 0 ~ "No", gretzky_data_copy$ENG == 1 ~ "Yes")
gretzky_data_copy$Result <- case_when(gretzky_data_copy$Result == "W" ~ "Regulation Win",
                                      gretzky_data_copy$Result == "L" ~ "Regulation Loss",
                                      gretzky_data_copy$Result == "OTW" ~ "Overtime Win",
                                      gretzky_data_copy$Result == "OTL" ~ "Overtime Loss",
                                      gretzky_data_copy$Result == "T" ~ "Tie")
gretzky_data_copy$HomeAway <- case_when(gretzky_data_copy$HomeAway == "H" ~ "Home", gretzky_data_copy$HomeAway == "A" ~ "Away")
gretzky_data_copy$Strength <- case_when(gretzky_data_copy$Strength == "EV" ~ "Even Strength", gretzky_data_copy$Strength == "PP" ~ "Power Play", gretzky_data_copy$Strength == "SH" ~ "Shorthanded")
gretzky_data_copy$Time <- substr(gretzky_data_copy$Time, start = 12, stop = 16)
gretzky_data_copy$Team <- case_when(gretzky_data_copy$Team == "EDM" ~ "Edmonton Oilers",
                                    gretzky_data_copy$Team == "LAK" ~ "Los Angeles Kings",
                                    gretzky_data_copy$Team == "STL" ~ "St. Louis Blues",
                                    gretzky_data_copy$Team == "NYR" ~ "New York Rangers")

gretzky_data_copy <- merge(gretzky_data_copy, name_table, by.x = c("Opponent"), by.y = c("Abbreviation"))

gretzky_data_copy <- gretzky_data_copy[c(2:ncol(gretzky_data_copy))]

colnames(gretzky_data_copy) <- c("Date", "Team", "Age", "1st Assist", "2nd Assist", "Goalie", "Period", "Time", "Strength", "Arena", "Result", "Home/Away", "Empty Net Goal", "Penalty Shot Goal", "Opponent")

gretzky_data_copy <- gretzky_data_copy[, c(1, 2, 15, 3:10, 12, 11, 13, 14)]

gretzky_data_copy <- left_join(gretzky_data_copy, gretzky_potential_games[c(1, 3, 4)], by = "Date") %>%
  mutate(Final = paste(GF, "-", GA))

gretzky_data_copy <- gretzky_data_copy[, c(1:13, 18, 14:15)]

colnames(gretzky_data_copy) <- c("Date", "Team", "Opponent", "Age", "1st Assist", "2nd Assist", "Goalie", "Period", "Time", "Strength", "Arena", "Home/Away", "Result", "Final Score", "Empty Net Goal", "Penalty Shot Goal")

gretzky_data_copy <- gretzky_data_copy %>%
  arrange(desc(Date))

gretzky_data_copy$cgoal <- rev(c(1:894))

gretzky_data_copy <- gretzky_data_copy[, c(1:4, 17, 5:16)]

colnames(gretzky_data_copy) <- c("Date", "Team", "Opponent", "Age", "Career Goal Number", "1st Assist", "2nd Assist", "Goalie", "Period", "Time", "Strength", "Arena", "Home/Away", "Result", "Final Score", "Empty Net Goal", "Penalty Shot Goal")
```

<!-- ```{r, class.source="code-r-small"} -->

<!-- p1_scatter <- cv_states_today %>% -->
<!--   plot_ly(x = ~pop_density, y = ~deathsper100k, -->
<!--           type = 'scatter', mode = 'markers', color = ~state, -->
<!--           size = ~population, sizes = c(5, 70), marker = list(sizemode='diameter', opacity=0.5), -->
<!--           hoverinfo = 'text', -->
<!--           text = ~paste( paste(state, ":", sep=""), paste(" Cases per 100k: ", per100k, sep="") , paste(" Deaths per 100k: ", -->
<!--                         deathsper100k, sep=""), sep = "<br>")) %>% -->
<!--   layout(title = "Population-normalized COVID-19 deaths vs. population density", -->
<!--                   yaxis = list(title = "Deaths per 100k"), xaxis = list(title = "Population Density"), -->
<!--          hovermode = "compare") -->

<!-- # filter out "District of Columbia" -->
<!-- cv_states_today_scatter <- cv_states_today %>% filter(state!="District of Columbia") -->

<!-- p2_scatter <- cv_states_today_scatter %>% -->
<!--   plot_ly(x = ~pop_density, y = ~deathsper100k, -->
<!--           type = 'scatter', mode = 'markers', color = ~state, -->
<!--           size = ~population, sizes = c(5, 70), marker = list(sizemode='diameter', opacity=0.5), -->
<!--           hoverinfo = 'text', -->
<!--           text = ~paste( paste(state, ":", sep=""), paste(" Cases per 100k: ", per100k, sep="") , paste(" Deaths per 100k: ", -->
<!--                         deathsper100k, sep=""), sep = "<br>")) %>% -->
<!--   layout(title = "Population-normalized COVID-19 deaths vs. population density", -->
<!--                   yaxis = list(title = "Deaths per 100k"), xaxis = list(title = "Population Density"), -->
<!--          hovermode = "compare") -->
<!-- ``` -->

### Ovechkin

```{r, echo = FALSE}
datatable2(x = ovi_data_copy, vars = colnames(ovi_data_copy)[-c(1, 2, 3, 5)])
```

### Gretzky

```{r, echo = FALSE}
datatable2(x = gretzky_data_copy, vars = colnames(gretzky_data_copy)[-c(1, 2, 3, 5)])
```

## {-}

<br>

## Ovechkin and Gretzky Goals by Goalie Scored On (Excluding Empty Net Goals) {.tabset}

This interactive visual shows the number of goals scored by Ovechkin and Gretzky grouped by the goalie on which they scored those goals (as Ovechkin is still active in the NHL, his data is accurate as of April 12 2022):

```{r, echo = FALSE, fig.height = 100}
ovi_goalies <- ovi_data %>%
  filter(!is.na(Goalie)) %>%
  group_by(Goalie) %>%
  summarise(Goals = n())

gretzky_goalies <- gretzky_data %>%
  filter(!is.na(Goalie)) %>%
  group_by(Goalie) %>%
  summarise(Goals = n())

ovi_goalies_plot <- ovi_goalies %>%
  ggplot(aes(x = reorder(Goalie, Goals), y = Goals, text = paste("Goalie: ", Goalie, '\nGoals: ', Goals))) +
  geom_bar(stat = "identity", fill = "red") +
  ylab("Goals") +
  xlab("Goalie") +
  ggtitle("Number of goals scored on various goalies by Ovechkin \n throughout in his NHL career") +
  theme_minimal() +
  coord_flip()

gretzky_goalies_plot <- gretzky_goalies %>%
  ggplot(aes(x = reorder(Goalie, Goals), y = Goals, text = paste("Goalie: ", Goalie, '\nGoals: ', Goals))) +
  geom_bar(stat = "identity", fill = "blue") +
  ylab("Goals") +
  xlab("Goalie") +
  ggtitle("Number of goals scored on various goalies by Gretzky \n throughout in his NHL career") +
  theme_minimal() +
  coord_flip()
  
```


<!-- ```{r, class.source="code-r-small"} -->

<!-- p1_scatter <- cv_states_today %>% -->
<!--   plot_ly(x = ~pop_density, y = ~deathsper100k, -->
<!--           type = 'scatter', mode = 'markers', color = ~state, -->
<!--           size = ~population, sizes = c(5, 70), marker = list(sizemode='diameter', opacity=0.5), -->
<!--           hoverinfo = 'text', -->
<!--           text = ~paste( paste(state, ":", sep=""), paste(" Cases per 100k: ", per100k, sep="") , paste(" Deaths per 100k: ", -->
<!--                         deathsper100k, sep=""), sep = "<br>")) %>% -->
<!--   layout(title = "Population-normalized COVID-19 deaths vs. population density", -->
<!--                   yaxis = list(title = "Deaths per 100k"), xaxis = list(title = "Population Density"), -->
<!--          hovermode = "compare") -->

<!-- # filter out "District of Columbia" -->
<!-- cv_states_today_scatter <- cv_states_today %>% filter(state!="District of Columbia") -->

<!-- p2_scatter <- cv_states_today_scatter %>% -->
<!--   plot_ly(x = ~pop_density, y = ~deathsper100k, -->
<!--           type = 'scatter', mode = 'markers', color = ~state, -->
<!--           size = ~population, sizes = c(5, 70), marker = list(sizemode='diameter', opacity=0.5), -->
<!--           hoverinfo = 'text', -->
<!--           text = ~paste( paste(state, ":", sep=""), paste(" Cases per 100k: ", per100k, sep="") , paste(" Deaths per 100k: ", -->
<!--                         deathsper100k, sep=""), sep = "<br>")) %>% -->
<!--   layout(title = "Population-normalized COVID-19 deaths vs. population density", -->
<!--                   yaxis = list(title = "Deaths per 100k"), xaxis = list(title = "Population Density"), -->
<!--          hovermode = "compare") -->
<!-- ``` -->

### Ovechkin

```{r, echo = FALSE, fig.height = 100}
ggplotly(ovi_goalies_plot, tooltip = c("text")) %>%
  layout(autosize = F, height = 2000, hoverlabel=list(bgcolor="white"))
```

### Gretzky

```{r, echo = FALSE, fig.height = 100}
ggplotly(gretzky_goalies_plot, tooltip = c("text")) %>%
  layout(autosize = F, height = 2000, hoverlabel=list(bgcolor="white"))
```

## {-}

<br>

Done!

<br>
<br>